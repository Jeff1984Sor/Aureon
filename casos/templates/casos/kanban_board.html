{% extends 'core/base.html' %}

{% block title %}{{ titulo }}{% endblock %}
{% block page_title %}{{ titulo }}{% endblock %}

{% block content %}
<!-- Filtro de Profissional -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row align-items-end">
            <div class="col-md-4">
                <label for="profissional" class="form-label">Filtrar por Profissional</label>
                <!-- O 'name' do select agora é 'profissional' -->
                <select name="profissional" id="profissional" class="form-select">
                    <option value="">Todos os Profissionais</option>
                    <!-- O loop agora itera sobre 'profissionais' (que são Users) -->
                    {% for user in profissionais %}
                    <option value="{{ user.id }}" {% if request.GET.profissional == user.id|stringformat:"s" %}selected{% endif %}>
                        {{ user.get_full_name|default:user.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Filtrar por Status</label>
                <select name="status" id="status" class="form-select">
                    <option value="">Todos os Status</option>
                    {% for status in statuses %}
                    <option value="{{ status.id }}" {% if request.GET.status == status.id|stringformat:"s" %}selected{% endif %}>
                        {{ status.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Filtrar</button>
            </div>
            <div class="col-md-2">
                <a href="{% url 'kanban_board' %}" class="btn btn-secondary w-100">Limpar</a>
            </div>
        </form>
    </div>
</div>

<!-- Container do Kanban com rolagem horizontal -->
<div class="kanban-container">
    {% for fase, casos_na_fase in kanban_columns.items %}
    <div class="kanban-column">
        <div class="kanban-column-header">
            <h6 class="mb-0">{{ fase.nome }}</h6>
            <span class="badge bg-secondary rounded-pill">{{ casos_na_fase|length }}</span>
        </div>
        <div class="kanban-column-body">
            {% for caso in casos_na_fase %}
            <a href="{% url 'caso_detail' caso.pk %}" class="kanban-card-link">
                <div class="card kanban-card mb-2">
                    <div class="card-body">
                        <p class="card-title fw-bold mb-1">Caso #{{ caso.id }}: {{ caso.titulo_caso }}</p>
                        <p class="card-text small text-muted mb-0">
                            <i class="bi bi-person"></i> {{ caso.cliente.nome_razao_social|truncatechars:30 }}
                        </p>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<style>
    .kanban-container {
        display: flex;
        overflow-x: auto; /* Permite rolagem horizontal */
        gap: 1rem;
        padding-bottom: 1rem;
    }
    .kanban-column {
        flex: 0 0 300px; /* Largura fixa da coluna */
        background-color: #e9ecef;
        border-radius: 0.375rem;
    }
    .kanban-column-header {
        padding: 0.75rem 1rem;
        background-color: #dee2e6;
        border-bottom: 1px solid #ccc;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .kanban-column-body {
        padding: 1rem;
        height: 60vh; /* Altura da área de cards */
        overflow-y: auto;
    }
    .kanban-card-link {
        text-decoration: none;
        color: inherit;
    }
    .kanban-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 0 5px rgba(13, 110, 253, 0.5);
    }
</style>
{% endblock %}