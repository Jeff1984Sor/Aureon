{% extends 'core/base.html' %}

{% block title %}Detalhes do Caso #{{ caso.id }}{% endblock %}
{% block page_title %}Detalhes do Caso #{{ caso.id }} - {{ caso.titulo_caso }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <!-- NAVEGAÇÃO DAS ABAS -->
        <ul class="nav nav-tabs" id="casoTab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="detalhes-tab" data-bs-toggle="tab" data-bs-target="#detalhes-tab-pane" type="button" role="tab">Detalhes</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="andamentos-tab" data-bs-toggle="tab" data-bs-target="#andamentos-tab-pane" type="button" role="tab">Andamentos</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="tarefas-tab" data-bs-toggle="tab" data-bs-target="#tarefas-tab-pane" type="button" role="tab">Tarefas</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="timesheet-tab" data-bs-toggle="tab" data-bs-target="#timesheet-tab-pane" type="button" role="tab">Timesheet</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="workflow-tab" data-bs-toggle="tab" data-bs-target="#workflow-tab-pane" type="button" role="tab">Workflow</button></li>
        </ul>

        <!-- CONTEÚDO DAS ABAS -->
        <div class="tab-content" id="casoTabContent">
            
            <!-- ABA 1: DETALHES DO CASO -->
            <div class="tab-pane fade show active" id="detalhes-tab-pane" role="tabpanel">
                <div class="row g-4 py-4">
                    <div class="col-md-12"><h5>Informações Gerais</h5><ul class="list-group list-group-flush"><li class="list-group-item"><strong>Status Geral:</strong> <span class="badge bg-primary fs-6">{{ caso.status.nome }}</span></li><li class="list-group-item"><strong>Fase Atual do Workflow:</strong> {% if caso.fase_atual_workflow %}<span class="badge bg-secondary fs-6">{{ caso.fase_atual_workflow.nome }}</span>{% else %}<span class="text-muted">Nenhum workflow ativo</span>{% endif %}</li><li class="list-group-item"><strong>Cliente:</strong> {{ caso.cliente.nome_razao_social }}</li><li class="list-group-item"><strong>Data de Entrada:</strong> {{ caso.data_entrada|date:"d/m/Y" }}</li><li class="list-group-item"><strong>Nº Sinistro:</strong> {{ caso.numero_sinistro|default:"N/A" }}</li><li class="list-group-item"><strong>Nº Apólice:</strong> {{ caso.numero_apolice|default:"N/A" }}</li><li class="list-group-item"><strong>Nº Aviso:</strong> {{ caso.numero_aviso|default:"N/A" }}</li></ul></div>
                    <div class="col-12"><hr></div>
                    <div class="col-md-6"><h5>Responsáveis</h5><ul class="list-group list-group-flush"><li class="list-group-item">
    <strong>Responsável:</strong> 
    {% if caso.advogado_responsavel %}
        {{ caso.advogado_responsavel.user.get_full_name|default:caso.advogado_responsavel.user.username }}
    {% else %}
        <span class="text-muted">Não definido</span>
    {% endif %}
</li><li class="list-group-item"><strong>Analista:</strong> {{ caso.analista.nome|default:"N/A" }}</li></ul></div>
                    <div class="col-md-6"><h5>Partes Envolvidas</h5><ul class="list-group list-group-flush"><li class="list-group-item"><strong>Segurado:</strong> {{ caso.segurado|default:"N/A" }}</li><li class="list-group-item"><strong>Terceiro:</strong> {{ caso.terceiro|default:"N/A" }}</li></ul></div>
                    <div class="col-12"><hr></div>
                    <div class="col-md-6"><h5>Detalhes do Sinistro</h5><ul class="list-group list-group-flush"><li class="list-group-item"><strong>Cobertura:</strong> {{ caso.cobertura.nome|default:"N/A" }}</li><li class="list-group-item"><strong>Motivo:</strong> {{ caso.motivo.nome|default:"N/A" }}</li><li class="list-group-item"><strong>Produto:</strong> {{ caso.produto.nome|default:"N/A" }}</li></ul></div>
                    <div class="col-md-6"><h5>Valores e Prazos</h5><ul class="list-group list-group-flush"><li class="list-group-item"><strong>Valor da Causa:</strong> R$ {{ caso.valor_causa|floatformat:2|default:"0,00" }}</li><li class="list-group-item"><strong>Prejuízo Apurado:</strong> R$ {{ caso.valor_prejuizo_apurado|floatformat:2|default:"0,00" }}</li><li class="list-group-item"><strong>Total de Horas Trabalhadas:</strong> {{ caso.total_horas_trabalhadas }}</li></ul></div>
                </div>
            </div>

            <!-- ABA 2: ANDAMENTOS -->
            <div class="tab-pane fade" id="andamentos-tab-pane" role="tabpanel">
                <div class="py-4"><h5>Adicionar Novo Andamento</h5><form action="{% url 'add_andamento' caso.pk %}" method="post">{% csrf_token %}{{ andamento_form.as_p }}<button type="submit" class="btn btn-success mt-2">Salvar Andamento</button></form><hr class="my-4"><h5>Histórico de Andamentos</h5>{% for andamento in caso.andamentos.all %}<div class="card mb-3"><div class="card-body"><p class="card-text">{{ andamento.descricao|linebreaksbr }}</p></div><div class="card-footer text-muted small d-flex justify-content-between"><span><strong>Data:</strong> {{ andamento.data_andamento|date:"d/m/Y" }}</span><span><strong>Registrado por:</strong> {{ andamento.usuario_criacao.username }} em {{ andamento.data_cadastro|date:"d/m/Y H:i" }}</span></div></div>{% empty %}<div class="alert alert-info">Nenhum andamento registrado.</div>{% endfor %}</div>
            </div>

            <!-- ABA 3: TAREFAS (COM BOTÃO DE MODAL) -->
            <div class="tab-pane fade" id="tarefas-tab-pane" role="tabpanel">
                <div class="py-4"><h5>Adicionar Nova Tarefa</h5><form action="{% url 'add_tarefa' caso.pk %}" method="post">{% csrf_token %}{{ tarefa_form.as_p }}<button type="submit" class="btn btn-primary mt-2">Adicionar Tarefa</button></form><hr class="my-4"><h5>Tarefas do Caso</h5><div class="table-responsive"><table class="table table-hover"><thead><tr><th>Tipo</th><th>Status</th><th>Responsável</th><th>Criação</th><th>Prazo</th><th>Conclusão</th><th>Ações</th></tr></thead><tbody>{% for tarefa in caso.tarefas.all %}<tr><td>{{ tarefa.tipo_tarefa.nome }}</td><td>{{ tarefa.get_status_display }}</td><td>{{ tarefa.responsavel.username|default:"-" }}</td><td>{{ tarefa.data_criacao|date:"d/m/Y" }}</td><td>{{ tarefa.data_conclusao_prevista|date:"d/m/Y" }}</td><td>{{ tarefa.data_conclusao|date:"d/m/Y H:i"|default:"-" }}</td><td>{% if tarefa.status != 'C' %}<button type="button" class="btn btn-success btn-sm" title="Concluir" data-bs-toggle="modal" data-bs-target="#concluirTarefaModal" data-form-url="{% url 'concluir_tarefa' tarefa.pk %}"><i class="bi bi-check-lg"></i></button>{% endif %}{% if tarefa.status == 'C' %}<form action="{% url 'reabrir_tarefa' tarefa.pk %}" method="post" class="d-inline">{% csrf_token %}<input type="hidden" name="next" value="{{ request.path }}#tarefas-tab-pane"><button type="submit" class="btn btn-secondary btn-sm" title="Reabrir"><i class="bi bi-arrow-counterclockwise"></i></button></form>{% endif %}<form action="{% url 'deletar_tarefa' tarefa.pk %}" method="post" class="d-inline" onsubmit="return confirm('Tem certeza?');">{% csrf_token %}<input type="hidden" name="next" value="{{ request.path }}#tarefas-tab-pane"><button type="submit" class="btn btn-danger btn-sm" title="Deletar"><i class="bi bi-trash"></i></button></form></td></tr>{% empty %}<tr><td colspan="7" class="text-center">Nenhuma tarefa.</td></tr>{% endfor %}</tbody></table></div></div>
            </div>

            <!-- ABA 4: TIMESHEET -->
            <div class="tab-pane fade" id="timesheet-tab-pane" role="tabpanel">
                <div class="py-4"><h5>Adicionar Lançamento</h5><form action="{% url 'add_timesheet' caso.pk %}" method="post">{% csrf_token %}{{ timesheet_form.as_p }}<button type="submit" class="btn btn-info mt-2">Lançar Horas</button></form><hr class="my-4"><div class="d-flex justify-content-between align-items-center"><h5>Horas Lançadas</h5><a href="{% url 'exportar_timesheet_excel' caso.pk %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-file-earmark-excel"></i> Exportar</a></div><div class="table-responsive mt-2"><table class="table table-hover"><thead><tr><th>Data</th><th>Profissional</th><th>Tempo</th><th>Descrição</th><th>Ações</th></tr></thead><tbody>{% for ts in caso.timesheets.all %}<tr><td>{{ ts.data_execucao|date:"d/m/Y" }}</td><td>{{ ts.profissional.username }}</td><td>{{ ts.tempo }}</td><td>{{ ts.descricao|truncatewords:15 }}</td><td><form action="{% url 'delete_timesheet' ts.pk %}" method="post" class="d-inline" onsubmit="return confirm('Tem certeza?');">{% csrf_token %}<input type="hidden" name="next" value="{{ request.path }}#timesheet-tab-pane"><button type="submit" class="btn btn-danger btn-sm" title="Excluir"><i class="bi bi-trash"></i></button></form></td></tr>{% empty %}<tr><td colspan="5" class="text-center">Nenhum lançamento.</td></tr>{% endfor %}</tbody></table></div></div>
            </div>

            <!-- ABA 5: WORKFLOW -->
            <div class="tab-pane fade" id="workflow-tab-pane" role="tabpanel">
                <div class="py-4">{% if caso.fase_atual_workflow %}<h4>Workflow: {{ caso.fase_atual_workflow.workflow.nome }}</h4><ul class="list-group mt-3">{% for fase_wf in caso.fase_atual_workflow.workflow.fases.all %}<li class="list-group-item {% if fase_wf == caso.fase_atual_workflow %}active{% endif %}"><strong>{{ fase_wf.ordem }}. {{ fase_wf.nome }}</strong></li>{% endfor %}</ul>{% else %}<div class="alert alert-warning">Nenhum workflow aplicado.</div>{% endif %}</div>
            </div>
        </div>
    </div>
    <div class="card-footer text-end">
        <a href="{% url 'caso_list' %}" class="btn btn-secondary">Voltar</a>
        <a href="{% url 'caso_update' caso.pk %}" class="btn btn-warning">Editar Caso</a>
        <a href="{% url 'gerar_caso_pdf' caso.pk %}" class="btn btn-danger" target="_blank"><i class="bi bi-file-earmark-pdf"></i> Gerar PDF</a>
    </div>
</div>

<!-- Modal de Conclusão de Tarefa (NOVO) -->
<div class="modal fade" id="concluirTarefaModal" tabindex="-1" aria-labelledby="concluirTarefaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="concluirTarefaModalLabel">Concluir Tarefa</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="concluir-tarefa-form" method="post">
          {% csrf_token %}
          {{ conclusao_form.as_p }}
          <input type="hidden" name="next" value="{{ request.path }}#tarefas-tab-pane">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-success" form="concluir-tarefa-form">Salvar e Concluir</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mantém a aba ativa após o reload
    const url = window.location.href;
    const hashIndex = url.indexOf('#');
    if (hashIndex !== -1) {
        const hash = url.substring(hashIndex);
        const tabButton = document.querySelector(`button[data-bs-target="${hash}"]`);
        if (tabButton) {
            const tabTrigger = new bootstrap.Tab(tabButton);
            tabTrigger.show();
        }
    }

    // Aplica máscara de tempo
    const tempoInput = document.getElementById('id_tempo_str');
    if (tempoInput) {
        const mascara = IMask(tempoInput, {
            mask: 'HH:MM',
            blocks: { HH: { mask: IMask.MaskedRange, from: 0, to: 99 }, MM: { mask: IMask.MaskedRange, from: 0, to: 59 } }
        });
    }

    // --- SCRIPT PARA O MODAL DE CONCLUSÃO ---
    const concluirTarefaModalElement = document.getElementById('concluirTarefaModal');
    if (concluirTarefaModalElement) {
        const form = concluirTarefaModalElement.querySelector('#concluir-tarefa-form');
        const inputDescricao = form.querySelector('#id_descricao_conclusao');

        concluirTarefaModalElement.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;
            const formUrl = button.getAttribute('data-form-url');
            form.action = formUrl;
            // Limpa a descrição anterior ao abrir o modal
            if(inputDescricao) {
                inputDescricao.value = '';
            }
        });
    }
});
</script>
{% endblock %}